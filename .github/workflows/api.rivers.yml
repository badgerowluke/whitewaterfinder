on:
  push:
    branches:
      - trunk
    paths:
      - 'whitewaterfinder.api.rivers/**'
      - 'whitewaterfinder.Core.Rivers/**'
      - 'whitewaterfinder.Repo.Rivers/**'
      - 'whitewaterfinder.BusinessObjects/**'
      - '.github/workflows/api.rivers.yml'
env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'whitewaterfinder.api.rivers'
jobs:
  build-and-test-rivers-api:
  #needs a check to verify if the infrastructure already exists or not.
    name: "build and test rivers api"
    runs-on: ubuntu-latest


    defaults:
      run:
        shell: bash

    steps:
      - name: "checkout"
        uses: actions/checkout@v2.1.0

      - name: setup dotnet 3.1.x
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.x'

      - name: setup dotnet
        uses: actions/setup-dotnet@v1
        with:
         dotnet-version: '5.0.x'



      - name: az login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZCLI_CREDS }}         

      - name: build test and release
        working-directory: whitewaterfinder.api.rivers
        run: |

          dotnet nuget add source --username ${{ secrets.GH_USER }} \
                                  --password ${{ secrets.GH_TOKEN }} \
                                  --store-password-in-clear-text \
                                  --name github "${{ secrets.GH_PACKAGES }}"
          dotnet restore 
          dotnet build --no-restore --configuration Release
          dotnet test --no-build --verbosity normal
          dotnet publish --no-restore -c Release -o './publish/rivers'
      
      # - name: deploy to funtionapp
      #   uses: azure/webapps-deploy@v2
      #   with: 
      #     app-name: 'paddle-finder'
      #     package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/publish/rivers'

      #DOING THIS FOR AN INTERNAL TEST OF K8S ENVIRONMENTS
      - name: build container
        run: |
          echo ${{ secrets.GH_PACKAGES }}
          docker build . --file ./whitewaterfinder.api.rivers/Dockerfile --label "runnumber=${GITHUB_RUN_ID}"
          # --tag paddlefinderregistry.azurecr.io/whitewaterfinder.api.rivers:$GITHUB_RUN_ID \
          --build-arg TOKEN=${{ secrets.GITHUB_TOKEN }} \
          --build-arg ENDPOINT=${{ secrets.GH_PACKAGES }} \
          --build-arg USER=${{ secrets.GH_USER }}
          # docker push paddlefinderregistry.azurecr.io/whitewaterfinder.api.rivers:$GITHUB_RUN_ID  

      - name: logout
        run: az logout

        
      - name: Log in to registry
        # This is where you will update the PAT to GITHUB_TOKEN
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin


      - name: Push image
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME

          # Change all uppercase to lowercase
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          # Strip git ref prefix from version
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          # Strip "v" prefix from tag name
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
          # Use Docker `latest` tag convention
          [ "$VERSION" == "master" ] && VERSION=latest
          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION


